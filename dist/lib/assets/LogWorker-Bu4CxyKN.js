(function(){"use strict";const u="MHBN_Logs",s="sessions";let r=null,c=null,i=!1;self.onmessage=async n=>{const{type:a,payload:t}=n.data;switch(a){case"INIT":await l(),self.postMessage({type:"INIT_DONE"});break;case"START":f();break;case"LOG_FRAME":i&&d(t);break;case"STOP":await g();break;case"EXPORT":await p();break}};function l(){return new Promise((n,a)=>{const t=indexedDB.open(u,1);t.onupgradeneeded=e=>{const o=e.target.result;o.objectStoreNames.contains(s)||o.createObjectStore(s,{keyPath:"id",autoIncrement:!0})},t.onsuccess=e=>{r=e.target.result,n()},t.onerror=e=>{console.error("Worker DB Error:",e.target.error),a(e.target.error)}})}function f(){if(!r)return;c=Date.now(),i=!0,r.transaction(s,"readwrite").objectStore(s).add({id:c,startTime:new Date().toISOString(),frames:[]}),self.postMessage({type:"RECORDING_STARTED",sessionId:c})}function d(n){if(!r||!c)return;const t=r.transaction(s,"readwrite").objectStore(s),e=t.get(c);e.onsuccess=()=>{const o=e.result;o&&(o.frames.push({t:Date.now(),...n}),t.put(o))}}async function g(){i=!1,self.postMessage({type:"RECORDING_STOPPED"})}async function p(){if(!r)return;const t=r.transaction(s,"readonly").objectStore(s).getAll();t.onsuccess=()=>{const e=t.result;if(e.length>0){const o=e[e.length-1];self.postMessage({type:"EXPORT_READY",data:o})}else console.warn("Worker: No sessions to export")}}})();
